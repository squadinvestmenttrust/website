<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squad Investment Trust üíñ‚ú®</title>
    <!-- Importing a cute, rounded font -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-pink: #ff69b4;
            --hot-pink: #ff1493;
            --light-pink: #ffb6c1;
            --pastel-purple: #e6e6fa;
            --deep-purple: #4a0e4e;
            --bg-gradient-1: #ff9a9e;
            --bg-gradient-2: #fecfef;
            --bg-gradient-3: #a1c4fd;
            --bg-gradient-4: #c2e9fb;
            --panel-bg: rgba(255, 255, 255, 0.85);
            --font-family: 'Nunito', sans-serif;
            --positive-green: #00c853;
            --negative-red: #ff4d4d;
        }

        /* --- ANIMATED BUBBLEGUM BACKGROUND --- */
        body {
            background: #ffffff;
            color: var(--deep-purple);
            font-family: var(--font-family);
            margin: 0;
            padding: 20px 10px;
            font-size: 15px;
            overflow-x: hidden;
            width: 100vw;
            box-sizing: border-box;
        }

        .main-container {
            max-width: 1100px;
            margin: auto;
            position: relative;
            z-index: 1;
        }

        /* --- CUTSIE ANIMATIONS --- */
        @keyframes wiggle {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(3deg) scale(1.03); }
            50% { transform: rotate(0deg) scale(1.03); }
            75% { transform: rotate(-3deg) scale(1.03); }
            100% { transform: rotate(0deg); }
        }
        .wiggle-hover {
            transition: all 0.2s ease;
        }
        .wiggle-hover:hover {
            animation: wiggle 0.4s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.06); }
            100% { transform: scale(1); }
        }

        /* --- HEADER & IMAGES --- */
        #imageContainer {
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(255, 105, 180, 0.3);
            background: white;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        #imageContainer img {
            border-radius: 15px;
            display: block;
            margin: auto;
            max-width: 100% !important;
            height: auto !important;
        }

        .tagline-container {
            text-align: center;
            margin-top: 10px;
            perspective: 1000px;
        }
        .tagline {
            display: inline-block;
            font-size: 1.1rem;
            font-weight: 900;
            letter-spacing: 2px;
            color: var(--hot-pink);
            text-shadow: 2px 2px 0px rgba(255,255,255,0.7);
            cursor: pointer;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .tagline:hover {
            transform: rotateX(360deg) scale(1.15);
        }

        /* --- LAYOUT UTILS --- */
        .loading-section {
            text-align: center;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--bg-gradient-2) 0%, #fff0f5 100%);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(255, 105, 180, 0.15);
            border: 2px solid var(--light-pink);
        }

        .header-text {
            min-height: 1.2em;
            font-size: 1.2rem;
            font-weight: 700;
            margin: 8px 0;
            color: var(--deep-purple);
        }

        /* --- NEW METRICS HEADER --- */
        .metrics-container {
            display: none; /* Hidden until loaded */
            justify-content: space-around;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 15px;
        }

        .metric-item {
            text-align: center;
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--pastel-purple) 0%, #f8f8ff 100%);
            border: 2px solid var(--light-pink);
            box-shadow: 0 5px 20px rgba(230, 230, 250, 0.8);
        }

        .metric-label {
            font-size: 0.85rem;
            font-weight: 900;
            color: var(--hot-pink);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--deep-purple);
        }

        /* Center AUM Styling */
        .metric-main {
            flex: 1.5;
            background: linear-gradient(135deg, var(--bg-gradient-2) 0%, var(--bg-gradient-1) 100%);
            border: 3px solid var(--main-pink);
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.4);
        }
        .metric-main .metric-label {
            font-size: 1rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .metric-main .metric-value {
            font-size: 2.2rem;
            color: white;
            font-weight: 900;
            text-shadow: 2px 2px 0px rgba(255, 20, 147, 0.4);
            animation: pulse 2.5s infinite ease-in-out;
        }

        /* Main Grid: 2 columns */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Mobile Adjustments */
        @media (max-width: 800px) {
            .dashboard-grid { grid-template-columns: 1fr; gap: 2.5rem; }
            body { padding: 10px 5px; } 
            .metric-main { transform: scale(1); }
        }

        /* --- HUD PANELS (GLASSMORPHISM) --- */
        .hud-panel {
            background: linear-gradient(135deg, #fffafa 0%, var(--bg-gradient-2) 100%);
            border-radius: 24px;
            padding: 25px 20px 20px 20px;
            box-shadow: 0 8px 32px rgba(255, 105, 180, 0.15);
            border: 2px solid var(--light-pink);
            position: relative;
        }
        
        .hud-title {
            position: absolute;
            top: -18px;
            left: 20px;
            background: linear-gradient(135deg, #ff7eb3 0%, #ff758c 100%);
            color: white;
            padding: 6px 16px;
            font-weight: 900;
            font-size: 0.9rem;
            letter-spacing: 1px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(255, 117, 140, 0.4);
            border: 2px solid white;
        }

        /* --- HOLDINGS TABLE (HEATMAP CARDS) --- */
        .holdings-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 12px;
            width: 100%;
            margin-top: 10px;
        }

        .holding-card {
            background: #fff0f5;
            border: 2px dashed var(--light-pink);
            padding: 12px;
            border-radius: 16px;
            min-width: 0; 
            cursor: pointer;
        }

        .holding-name {
            font-weight: 900;
            font-size: 1.05rem;
            color: var(--deep-purple);
            display: block;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }

        .holding-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 3px;
        }

        @media (max-width: 450px) {
            .holdings-grid-container { gap: 8px; }
            .holding-card { padding: 10px; border-radius: 12px; }
            .holding-name { font-size: 0.95rem; }
            .holding-row { font-size: 0.85rem; }
        }
        
        /* --- CHART STYLING --- */
        svg {
            width: 100%;
            height: auto;
            overflow: visible;
        }
        .chart-tooltip {
            position: absolute;
            background: var(--hot-pink);
            color: white;
            border: 2px solid white;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: bold;
            pointer-events: none;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(255, 20, 147, 0.4);
        }
        .pie-slice {
            cursor: pointer;
            transition: opacity 0.2s, transform 0.2s;
            transform-origin: center;
        }
        .pie-slice:hover { 
            opacity: 0.8; 
            transform: scale(1.03);
        }
        
        .line-path {
            stroke-dasharray: 2000;
            stroke-dashoffset: 2000;
            animation: drawLine 2.5s ease-out forwards;
            filter: drop-shadow(0px 4px 6px rgba(255, 20, 147, 0.3));
        }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }

        /* --- RETURNS TABLE --- */
        .returns-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.95rem;
            margin-top: 10px;
        }
        .returns-table td, .returns-table th {
            border-bottom: 2px dotted var(--light-pink);
            padding: 14px; 
            text-align: left;
            font-weight: 700;
        }
        .returns-table th { 
            color: var(--hot-pink);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 3px solid var(--main-pink);
        }
        .returns-table td:last-child, .returns-table th:last-child {
            text-align: right;
        }
        .returns-table tr:last-child td {
            border-bottom: none;
        }

        /* --- TYPING CURSOR (üíñ) --- */
        .cursor::after {
            content: ' üíñ';
            animation: blink 1s step-end infinite;
            display: inline-block;
            vertical-align: middle;
            margin-bottom: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* --- LOGS (CHAT BUBBLES) --- */
        #updatesContainer {
            font-size: 0.95rem;
            line-height: 1.5;
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .update-entry {
            background: var(--pastel-purple);
            color: var(--deep-purple);
            padding: 12px 16px;
            border-radius: 20px;
            border-bottom-left-radius: 5px; /* Chat bubble effect */
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            display: inline-block;
            max-width: 90%;
            position: relative;
            cursor: pointer;
        }
        
        /* Log Color Codes */
        .log-buy {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .log-sell {
            background: #ffe0e6;
            color: var(--negative-red);
            border: 2px solid var(--hot-pink);
        }
        .log-paid {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
        }

        /* Poll Container */
        .poll-wrapper {
            background: linear-gradient(135deg, var(--bg-gradient-4) 0%, var(--bg-gradient-3) 100%);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(161, 196, 253, 0.4);
            border: 2px solid white;
            text-align: center;
            margin-top: 2rem;
        }

    </style>
</head>
<body>

<div id="tooltip" class="chart-tooltip"></div>

<div class="main-container">
    <div id="imageContainer" style="overflow: hidden; height: 0; width: 100%; text-align: center; box-sizing: border-box;">
      <img id="headerImage" src="https://i.ibb.co/tPvYwKPZ/SIT.png" alt="Header Image">
    </div>
    
    <div class="tagline-container">
        <div class="tagline">
            BUY HIGH, SELL DOWN
        </div>
    </div>

    <br>

    <!-- Initial Loading Screen -->
    <div id="loading-container" class="loading-section">
        <div id="loading-text" class="header-text"></div>
    </div>

    <!-- The New Reordered Metrics Dashboard -->
    <div id="metrics-container" class="metrics-container">
        <div class="metric-item wiggle-hover">
            <div class="metric-label">Unit Price</div>
            <div id="unitprice-text" class="metric-value">...</div>
        </div>
        <div class="metric-item metric-main wiggle-hover">
            <div class="metric-label">Total AUM</div>
            <div id="aum-text" class="metric-value">...</div>
        </div>
        <div class="metric-item wiggle-hover">
            <div class="metric-label">Net Tendies</div>
            <div id="tendies-text" class="metric-value">...</div>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Holdings -->
        <div class="hud-panel">
            <div class="hud-title">üíñ OUR STONKS</div>
            <div id="table-container"></div>
        </div>

        <!-- Asset Allocation -->
        <div class="hud-panel" style="display:flex; align-items:center; justify-content:center; flex-direction: column;">
            <div class="hud-title">üç≠ YUMMY PIE</div>
            <div id="pie-chart-container" style="width: 80%; max-width: 300px; margin-top: 15px;"></div>
        </div>

        <!-- Returns -->
        <div class="hud-panel">
            <div class="hud-title">üéÄ WINS TO 31 JAN</div>
            <div id="returns-table-container"></div>
        </div>

        <!-- Line Chart -->
        <div class="hud-panel">
            <div class="hud-title">üìà SQUIGGLY LINE</div>
            <div id="graph-container" style="margin-top: 15px;"></div>
        </div>

        <!-- System Logs -->
        <div class="hud-panel" style="grid-column: 1 / -1;">
            <div class="hud-title">üí¨ BOYS CHAT</div>
            <div id="updatesContainer"></div>
        </div>
    </div>
        
    <div class="poll-wrapper wiggle-hover" id="poll-container" style="width:100%; max-width:600px; margin:auto;">
        <div style="text-align:center; font-size: 0.95rem; font-weight:900; letter-spacing: 2px; color: var(--hot-pink); margin-bottom: 15px;">
            IN SQUAD WE TRUST
        </div>
        <script>
            (function(i,s,o,g,r,a,m){
                i['QP']=r;
                i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments) },i[r].l=1*new Date();
                a=s.createElement(o),m=s.getElementsByTagName(o)[0];
                a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//scripts.poll-maker.com/3012/pollembed.js','qp');
        </script>
        <a href="#" data-poll="5551770xfDF94E9a-164" style="width:100%; display:block; text-align:center; color:#ff1493; font-family:'Nunito', sans-serif; font-weight:bold; text-decoration:none;"></a>
    </div>

</div>

<script>
    // --- DOM ELEMENTS ---
    const loadingContainerEl = document.getElementById('loading-container');
    const loadingTextEl = document.getElementById('loading-text');
    const metricsContainerEl = document.getElementById('metrics-container');
    
    const aumTextEl = document.getElementById('aum-text');
    const unitPriceTextEl = document.getElementById('unitprice-text');
    const tendiesTextEl = document.getElementById('tendies-text');
    
    const tableContainerEl = document.getElementById('table-container');
    const pieChartContainerEl = document.getElementById('pie-chart-container');
    const returnsTableContainerEl = document.getElementById('returns-table-container');
    const graphContainerEl = document.getElementById('graph-container');
    const tooltipEl = document.getElementById('tooltip');

    const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvIkFEd8DqGzQOSMan7QNAuwDI4fXgD1HB8PDbmnnqk5QmA0YNigbxyWuuKhoAys9VRKrbDqym2xDw/pub?output=csv';

    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    // --- UTILITIES ---
    async function typeText(element, text, speed = 30) {
        element.classList.add('cursor');
        element.innerHTML = "";
        let currentText = "";
        for (let i = 0; i < text.length; i++) {
            currentText += text.charAt(i);
            element.innerHTML = currentText;
            await sleep(speed + Math.random() * 20);
        }
        element.classList.remove('cursor');
    }

    async function typeDots(element, count = 3, speed = 300) {
        element.classList.add('cursor');
        for (let i = 0; i < count; i++) {
            element.textContent += '.';
            await sleep(speed);
        }
        element.classList.remove('cursor');
    }

    function parseCSV(str) {
        const arr = [];
        let quote = false; 
        let col, c;
        for (let row = col = c = 0; c < str.length; c++) {
            const cc = str[c], nc = str[c+1];
            arr[row] = arr[row] || [];
            arr[row][col] = arr[row][col] || '';

            if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }
            if (cc == '"') { quote = !quote; continue; }
            if (cc == ',' && !quote) { ++col; continue; }
            if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; continue; }
            if (cc == '\n' && !quote) { ++row; col = 0; continue; }
            if (cc == '\r' && !quote) { ++row; col = 0; continue; }
            
            arr[row][col] += cc;
        }
        return arr;
    }

    async function getSheetData() {
        try {
            const response = await fetch(SPREADSHEET_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvText = await response.text();
            return parseCSV(csvText);
        } catch (e) {
            console.error("Error:", e);
            loadingTextEl.textContent = "ü•∫ Oopsie! Data link severed~ üíî";
            return null;
        }
    }

    // --- RENDERERS ---

    function drawTable(data) {
        const holdings = data.slice(2).filter(row => row[0]);
        const fmtUSD0 = (n) => {
            const num = parseFloat(n);
            if (isNaN(num)) return n || '$0';
            return num.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
        };
        const fmtPct = (v) => {
            const raw = (v ?? '').toString().trim();
            if (raw === '') return '0%';
            if (raw.endsWith('%')) return raw;
            const num = parseFloat(raw);
            return isNaN(num) ? raw : `${num.toFixed(2)}%`;
        };

        let html = '<div class="holdings-grid-container">';
        
        for (let i = 0; i < holdings.length; i += 2) {
            const left = holdings[i];
            const right = holdings[i + 1];

            const createCard = (item) => {
                if(!item) return '';
                const name = item[0] || 'N/A';
                const value = fmtUSD0(item[3]); 
                // Pulling daily change percent/value from column N (index 13)
                const dailyChange = fmtPct(item[13]); 
                const profit = fmtPct(item[6]);
                
                const dailyVal = parseFloat(dailyChange);
                const profitVal = parseFloat(profit);

                // --- HEATMAP LOGIC BASED ON DAILY CHANGE ---
                let bgStyle = 'background: #fff0f5; border-color: var(--light-pink);'; // default
                if (!isNaN(dailyVal) && dailyChange !== '0%') {
                    if (dailyVal > 0) {
                        // Max opacity capped at 0.5 for aesthetic reasons
                        const intensity = Math.min(0.05 + (dailyVal / 10), 0.5); 
                        bgStyle = `background: rgba(0, 200, 83, ${intensity}); border-color: var(--positive-green); border-style: solid;`;
                    } else if (dailyVal < 0) {
                        const intensity = Math.min(0.05 + (Math.abs(dailyVal) / 10), 0.5);
                        bgStyle = `background: rgba(255, 77, 77, ${intensity}); border-color: var(--negative-red); border-style: solid;`;
                    }
                }

                // Text coloring
                const profitColor = profitVal < 0 ? 'var(--negative-red)' : 'var(--positive-green)';
                const dailyColor = dailyVal < 0 ? 'var(--negative-red)' : (dailyVal > 0 ? 'var(--positive-green)' : 'var(--deep-purple)');

                return `
                    <div class="holding-card wiggle-hover" style="${bgStyle}">
                        <span class="holding-name" title="${name}">${name}</span>
                        <div class="holding-row"><span>Val:</span><span>${value}</span></div>
                        <div class="holding-row"><span>P/L:</span><span style="color:${profitColor}">${profit}</span></div>
                        <div class="holding-row"><span>Day:</span><span style="color:${dailyColor}; font-weight:900;">${dailyChange}</span></div>
                    </div>
                `;
            }

            if(left && left[0]) html += createCard(left);
            if(right && right[0]) html += createCard(right);
        }
        html += '</div>';
        tableContainerEl.innerHTML = html;
    }

    function drawPieChart(data) {
        const holdingsData = data.slice(2)
            .filter(row => row[0] && parseFloat(row[3]) > 0)
            .map(row => ({ name: row[0], value: parseFloat(row[3]) }));

        const totalValue = holdingsData.reduce((sum, item) => sum + item.value, 0);
        if (totalValue === 0) {
            pieChartContainerEl.innerHTML = '<div style="text-align:center; font-weight:bold;">NO ASSETS ü•∫</div>';
            return;
        }

        const radius = 100;
        const cx = radius;
        const cy = radius;
        let startAngle = -90;

        let svgContent = `<svg viewBox="-5 -5 ${radius * 2 + 10} ${radius * 2 + 10}" preserveAspectRatio="xMidYMid meet">`;

        // K-Pop Bubblegum Palette
        const cuteColors = ['#ff758c', '#ff7eb3', '#ffa6c9', '#c781ff', '#8cc6ff', '#8cf0ff', '#ffe18c', '#ffb58c', '#d8bfd8'];

        holdingsData.forEach((item, index) => {
            const percentage = item.value / totalValue;
            const angle = percentage * 360;
            const endAngle = startAngle + angle;

            const start = polarToCartesian(cx, cy, radius, endAngle);
            const end = polarToCartesian(cx, cy, radius, startAngle);
            const largeArcFlag = angle > 180 ? "1" : "0";

            const d = [
                "M", cx, cy,
                "L", end.x, end.y,
                "A", radius, radius, 0, largeArcFlag, 1, start.x, start.y,
                "Z"
            ].join(" ");

            const fill = cuteColors[index % cuteColors.length];
            const tooltipText = `${item.name}: ${item.value.toLocaleString('en-US', {style:'currency', currency:'USD', maximumFractionDigits:0})} (${Math.round(percentage*100)}%)`;

            svgContent += `<path d="${d}" fill="${fill}" stroke="#fff" stroke-width="2" class="pie-slice" 
                           ontouchstart="showTooltip(event.touches[0], '${tooltipText}')"
                           onmousemove="showTooltip(evt, '${tooltipText}')" 
                           onmouseout="hideTooltip()"></path>`;
            
            startAngle = endAngle;
        });

        svgContent += `</svg>`;
        pieChartContainerEl.innerHTML = svgContent;
    }

    function showTooltip(evt, text) {
        tooltipEl.style.display = "block";
        tooltipEl.textContent = text;
        tooltipEl.style.left = (evt.pageX + 10) + 'px';
        tooltipEl.style.top = (evt.pageY + 10) + 'px';
    }

    function hideTooltip() {
        tooltipEl.style.display = "none";
    }

    function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
        return {
            x: centerX + (radius * Math.cos(angleInRadians)),
            y: centerY + (radius * Math.sin(angleInRadians))
        };
    }

    function drawLineGraph(data) {
        const graphData = data.slice(1)
            .filter(row => row[7] && row[8])
            .map(row => {
                const dateParts = row[7].split('/');
                return {
                    date: new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`),
                    value: parseFloat(row[8])
                };
            })
            .sort((a, b) => a.date - b.date);

        if (graphData.length < 2) return;

        const width = 800;
        const height = 400;
        const padding = 60;

        const maxValue = Math.max(...graphData.map(d => d.value));
        const yMax = Math.ceil(maxValue / 10000) * 10000;
        
        const startDate = new Date('2017-01-01');
        const today = new Date();
        const theEndDate = new Date(today.getFullYear() + 1, 0, 1);

        const xScale = (date) => padding + ((date - startDate) / (theEndDate - startDate)) * (width - padding * 2);
        const yScale = (value) => height - padding - (value / yMax) * (height - padding * 2);

        let svgContent = `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">`;

        // Axes and Grids (Pastel pink/purple tones)
        svgContent += `<line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="var(--light-pink)" stroke-width="3" stroke-linecap="round"></line>`;
        svgContent += `<line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="var(--light-pink)" stroke-width="3" stroke-linecap="round"></line>`;

        for (let i = 0; i <= yMax; i += 10000) {
            const y = yScale(i);
            svgContent += `<line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="var(--pastel-purple)" stroke-width="2" stroke-dasharray="6,6"></line>`;
            svgContent += `<text x="${padding - 15}" y="${y + 5}" fill="var(--deep-purple)" text-anchor="end" font-size="16" font-weight="bold">$${i / 1000}K</text>`;
        }

        for (let year = 2017; year <= today.getFullYear() + 1; year++) {
            const x = xScale(new Date(`${year}-01-01`));
            svgContent += `<text x="${x}" y="${height - padding + 25}" fill="var(--deep-purple)" text-anchor="middle" font-size="16" font-weight="bold">${year}</text>`;
        }
        
        const points = graphData.map(d => `${xScale(d.date)},${yScale(d.value)}`).join(' ');
        
        // The main chart line - Bright hot pink
        svgContent += `<polyline points="${points}" fill="none" stroke="var(--hot-pink)" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" class="line-path"></polyline>`;
        
        svgContent += `</svg>`;
        graphContainerEl.innerHTML = svgContent;
    }

    function drawReturnsTable(data) {
        const safeGet = (r, c) => (data[r] && typeof data[r][c] !== 'undefined') ? data[r][c] : '';
        const periods = [
            { label: '1 Month', val: safeGet(1, 11) },
            { label: '3 Month', val: safeGet(2, 11) },
            { label: '6 Month', val: safeGet(3, 11) },
            { label: '1 Year', val: safeGet(4, 11) }
        ];

        let html = '<table class="returns-table">';
        html += '<thead><tr><th>PERIOD</th><th>RETURN</th></tr></thead><tbody>';
        
        periods.forEach(p => {
            let color = 'var(--positive-green)';
            let valStr = p.val;
            if(valStr && valStr.includes('-')) color = 'var(--negative-red)';
            
            if(!valStr.includes('%') && valStr !== '') {
                const f = parseFloat(valStr);
                if(!isNaN(f)) valStr = f.toFixed(2) + '%';
            }

            html += `<tr><td>${p.label}</td><td style="color:${color}; font-weight:900; font-size:1.1rem;">${valStr}</td></tr>`;
        });
        html += '</tbody></table>';
        returnsTableContainerEl.innerHTML = html;
    }

    function loadPortfolioUpdates(data) {
        const updates = data.slice(1)
            .map(row => row[9])
            .filter(item => item && item.trim() !== '');

        const container = document.getElementById('updatesContainer');
        container.innerHTML = '';

        if (updates.length === 0) {
            container.innerHTML = '<div style="text-align:center; opacity:0.6; font-weight:bold;">No recent updates üå∏</div>';
            return;
        }

        updates.forEach((update) => {
            const div = document.createElement('div');
            
            // Log Color Coding Logic
            let extraClass = '';
            let emoji = '‚ú®';
            const upperText = update.toUpperCase();
            
            if (upperText.includes('BUY')) {
                extraClass = 'log-buy';
                emoji = 'üõçÔ∏è';
            } else if (upperText.includes('SELL')) {
                extraClass = 'log-sell';
                emoji = 'üí∏';
            } else if (upperText.includes('PAID')) {
                extraClass = 'log-paid';
                emoji = 'üí∞';
            }

            div.className = `update-entry wiggle-hover ${extraClass}`;
            div.innerHTML = `<span style="margin-right:5px; font-size:1.1rem;">${emoji}</span> ${update}`;
            container.appendChild(div);
        });
    }

    // --- MAIN EXECUTION ---
    async function main() {
        await typeText(loadingTextEl, 'FETCHING SQUAD INVEST NUMBERS ~', 30);
        await typeDots(loadingTextEl, 4, 150);
        await sleep(200);
        
        const sheetData = await getSheetData();
        
        if (!sheetData) return;

        loadingTextEl.innerHTML = '';
        await typeText(loadingTextEl, 'FOUND 6 and 7, ANALYSING üå∏', 30);
        await typeDots(loadingTextEl, 4, 150);
        await sleep(300);
        
        // Hide initial loading screen, show awesome new metrics container
        loadingContainerEl.style.display = 'none';
        metricsContainerEl.style.display = 'flex';

        const jokingValue = parseFloat(sheetData[1][3]).toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }) || '$0';
        const unitRaw = sheetData[1][4];
        const unitPrice = parseFloat(unitRaw).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        const tendiesValue = parseFloat(sheetData[1][5]).toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }) || '$0';

        // Load Header Values 
        aumTextEl.textContent = jokingValue;
        unitPriceTextEl.textContent = unitPrice;
        tendiesTextEl.textContent = tendiesValue;
        
        drawTable(sheetData);
        drawPieChart(sheetData);
        drawReturnsTable(sheetData);
        drawLineGraph(sheetData);
        loadPortfolioUpdates(sheetData);
    }

    window.onload = main;

    // Soft reveal for the image instead of the CRT wipe
    window.addEventListener('load', () => {
        const image = document.getElementById('headerImage');
        const container = document.getElementById('imageContainer');
        const step = 8;
        const fps = 60;
        const reveal = () => {
            let height = 0;
            // Pad the height slightly to account for the container padding
            const targetHeight = (image.naturalHeight || 400) + 20; 
            const interval = setInterval(() => {
                height += step;
                container.style.height = height + 'px';
                if (height >= targetHeight) {
                    container.style.height = 'auto';
                    clearInterval(interval);
                }
            }, 1000 / fps);
        };
        if (image.complete) reveal();
        else image.onload = reveal;
    });

</script>
</body>
</html>
