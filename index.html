<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Squad Investment Trust</title>

<!-- Chart.js & DataLabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
  :root {
    --green: #00ff00;
  }

  html, body {
    margin: 0;
    padding: 0 16px;
    background: #000;
    color: var(--green);
    font-family: "Courier New", monospace;
    font-size: 18px;
  }

  /* typing cursor */
  .cursor::after {
    content: "_";
    animation: blink 1s steps(1) infinite;
  }
  @keyframes blink { 50% { opacity: 0; } }

  /* container layout */
  #content { display: flex; flex-direction: column; gap: 24px; }
  #upperRow { display: flex; flex-wrap: wrap; gap: 24px; align-items: flex-start; }
  #tableBox { white-space: pre; }
  #pieBox, #lineBox { width: 100%; max-width: 640px; }
  canvas { width: 100% !important; height: auto !important; background: #000; }

  /* axes & grid styling */
  .chart-axes line,
  .chart-axes path,
  .chart-grid line {
    stroke: var(--green) !important;
  }
  .chart-axes text { fill: var(--green) !important; font-family: "Courier New", monospace; }
</style>
</head>

<body>
<div id="loading" class="cursor"></div>

<!-- everything else lives here, revealed after load -->
<div id="content" style="display:none;">
  <div id="summary"></div>
  <div id="tendies"></div>

  <div id="upperRow">
    <div id="tableBox"></div>
    <div id="pieBox"><canvas id="pie"></canvas></div>
  </div>

  <div id="lineBox"><canvas id="line"></canvas></div>
</div>

<script>
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvIkFEd8DqGzQOSMan7QNAuwDI4fXgD1HB8PDbmnnqk5QmA0YNigbxyWuuKhoAys9VRKrbDqym2xDw/pub?output=csv";

// util: delay
const wait = ms => new Promise(r => setTimeout(r, ms));

// step‑by‑step loader
async function runLoader() {
  const el = document.getElementById('loading');

  async function type(text, speed = 75) {
    el.classList.add('cursor');
    for (let ch of text) {
      el.textContent += ch;
      await wait(speed);
    }
    el.classList.remove('cursor');
  }

  await type('Loading');
  for (let i = 0; i < 5; i++) {
    await wait(300);
    el.textContent += '.';
  }
  await wait(500);
  el.textContent = '';
  await type('.....and it\'s gone');
  await wait(800);
}

// fetch and parse CSV
async function fetchData() {
  const res = await fetch(SHEET_CSV);
  if (!res.ok) throw Error('fetch failed');
  const csv = await res.text();
  const rows = csv.trim().split('\n').map(r => r.split(','));

  // core values
  const have       = Number(rows[1][3].replace(/[^0-9.-]+/g, ''));
  const tendiesVal = Number(rows[1][5].replace(/[^0-9.-]+/g, ''));

  // holdings (start row 3)
  const holdings = [];
  for (let i = 2; i < rows.length; i++) {
    const [h, , , val, , prof$, profPct] = rows[i];
    if (!h) break; // stop at blank line
    holdings.push({
      holding: h,
      value:  Number(val.replace(/[^0-9.-]+/g, '')),
      profit$: prof$,
      profitPct: profPct
    });
  }

  // history columns H & I (zero‑based 7 & 8)
  const dates = [], values = [];
  for (let i = 0; i < rows.length; i++) {
    const date = rows[i][7], val = rows[i][8];
    if (date && val) {
      dates.push(date);
      values.push(Number(val.replace(/[^0-9.-]+/g, '')));
    }
  }

  return {have, tendiesVal, holdings, dates, values};
}

// ASCII table builder
function buildTable(headers, rows) {
  const colWidths = headers.map((h, i) =>
    Math.max(h.length, ...rows.map(r => r[i].toString().length))
  );

  const line = '+' + colWidths.map(w => '-'.repeat(w + 2)).join('+') + '+\n';
  const rowStr = r => '| ' + r.map((c,i) => c.toString().padEnd(colWidths[i])).join(' | ') + ' |\n';

  let txt = line + rowStr(headers) + line;
  rows.forEach(r => { txt += rowStr(r); });
  txt += line;
  return txt;
}

// draw charts
function drawPie(ctx, labels, data) {
  new Chart(ctx, {
    type: 'pie',
    plugins:[ChartDataLabels],
    data: {
      labels,
      datasets:[{
        data,
        borderColor: '#00ff00',
        borderWidth: 2,
        backgroundColor: data.map(()=>'rgba(0,0,0,0)')
      }]
    },
    options:{
      plugins:{
        tooltip:{enabled:false},
        legend:{display:false},
        datalabels:{
          color:'#00ff00',
          formatter:(v,ctx)=>{
            const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
            return ctx.chart.data.labels[ctx.dataIndex] + ' ' +
                   Math.round(v/total*100)+'%';
          }
        }
      }
    }
  });
}

function drawLine(ctx, labels, data) {
  new Chart(ctx, {
    type:'line',
    data:{
      labels,
      datasets:[{
        data,
        borderColor:'#00ff00',
        borderWidth:2,
        pointRadius:0,
        fill:false
      }]
    },
    options:{
      plugins:{tooltip:{enabled:false}, legend:{display:false}},
      interaction:{mode:'index',intersect:false},
      scales:{
        x:{
          grid:{color:'#003300'},
          ticks:{color:'#00ff00'},
          title:{display:false}
        },
        y:{
          grid:{color:'#003300'},
          ticks:{
            color:'#00ff00',
            callback:v=>'$'+(v/1000)+'K'
          },
          beginAtZero:true,
          suggestedMax: Math.ceil(Math.max(...data)/10000)*10000
        }
      }
    }
  });
}

// sequential reveal
async function buildUI() {
  try {
    const {have, tendiesVal, holdings, dates, values} = await fetchData();

    // replace loading text
    const loadBox = document.getElementById('loading');
    loadBox.textContent = '';
    document.getElementById('content').style.display = 'flex';

    // summary
    document.getElementById('summary').textContent =
      `just joking, you have $${have.toLocaleString()}`;

    await wait(500);

    // tendies
    document.getElementById('tendies').textContent =
      `Total tendies to date $${tendiesVal.toLocaleString()}`;

    await wait(500);

    // table
    const tblHeaders = ['Holding','Value','Profit'];
    const tblRows = holdings.map(h=>[
      h.holding,
      h.value.toLocaleString(),
      h.profit$
    ]);
    document.getElementById('tableBox').textContent =
      buildTable(tblHeaders, tblRows);

    await wait(500);

    // pie
    drawPie(document.getElementById('pie'), holdings.map(h=>h.holding), holdings.map(h=>h.value));

    await wait(500);

    // line
    // convert dates like DD/MM/YYYY to YYYY label (use regex fallback)
    const yrLabels = dates.map(d=>d.split('/').pop());
    drawLine(document.getElementById('line'), yrLabels, values);

  } catch(e) {
    document.body.textContent = 'failure to load';
    console.error(e);
  }
}

// run
(async()=>{
  await runLoader();
  await buildUI();
})();
</script>
</body>
</html>
