<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squad Investment Trust // TERMINAL</title>
    <style>
        :root {
            --main-color: #00FF41;
            --dim-color: #008F11;
            --bg-color: #000000;
            --panel-bg: #001002;
            --font-family: 'Courier New', Courier, monospace;
        }

        /* --- CRT EFFECT OVERLAY --- */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 999;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            opacity: 0.6;
        }

        body {
            background-color: var(--bg-color);
            color: var(--main-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 10px;
            font-size: 14px;
            text-shadow: 0 0 5px var(--dim-color);
            overflow-x: hidden;
            width: 100vw;
            box-sizing: border-box;
        }

        /* Screen Flicker Animation */
        @keyframes flicker {
            0% { opacity: 0.97; }
            5% { opacity: 0.92; }
            10% { opacity: 0.9; }
            15% { opacity: 0.95; }
            20% { opacity: 0.85; }
            50% { opacity: 0.95; }
            80% { opacity: 0.90; }
            100% { opacity: 0.98; }
        }
        .crt-container {
            animation: flicker 0.15s infinite;
            max-width: 1100px;
            margin: auto;
            position: relative;
            z-index: 1;
        }

        /* --- LAYOUT UTILS --- */
        .header-section {
            text-align: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px dashed var(--dim-color);
            padding-bottom: 1rem;
        }

        .header-text {
            min-height: 1.2em;
            font-size: 1rem;
            white-space: pre-wrap;
            margin: 5px 0;
        }

        .highlight {
            color: #fff;
            text-shadow: 0 0 8px #fff;
            font-weight: bold;
        }

        /* Main Grid: 2 columns */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Mobile Adjustments */
        @media (max-width: 800px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            body { padding: 5px; } 
        }

        /* --- HUD PANELS --- */
        .hud-panel {
            border: 1px solid var(--dim-color);
            background: var(--panel-bg);
            padding: 1rem;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.05);
            position: relative;
            border-radius: 4px;
            margin-bottom: 1.5rem; /* Spacing between stacked panels */
        }
        
        /* Decorative Corners */
        .hud-panel::after {
            content: ''; position: absolute; top: -1px; left: -1px;
            width: 10px; height: 10px;
            border-top: 2px solid var(--main-color); border-left: 2px solid var(--main-color);
        }
        .hud-panel::before {
            content: ''; position: absolute; bottom: -1px; right: -1px;
            width: 10px; height: 10px;
            border-bottom: 2px solid var(--main-color); border-right: 2px solid var(--main-color);
        }
        
        .hud-title {
            position: absolute;
            top: -10px; left: 15px;
            background-color: var(--bg-color);
            padding: 0 10px;
            font-weight: bold;
            font-size: 0.8rem;
            letter-spacing: 2px;
            color: var(--dim-color);
        }

        /* --- HOLDINGS TABLE (2-COLUMNS) --- */
        .holdings-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 10px;
            width: 100%;
        }

        .holding-card {
            border: 1px solid var(--dim-color);
            padding: 8px;
            border-radius: 2px;
            background: rgba(0, 255, 65, 0.02);
            min-width: 0; 
        }

        .holding-name {
            font-weight: bold;
            font-size: 0.95rem;
            color: #fff;
            display: block;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .holding-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Mobile Tweaks for Holdings */
        @media (max-width: 450px) {
            .holdings-grid-container { gap: 4px; }
            .holding-card { padding: 5px; }
            .holding-name { font-size: 0.8rem; }
            .holding-row { font-size: 0.75rem; }
        }
        
        /* --- CHART STYLING --- */
        svg {
            width: 100%;
            height: auto;
            overflow: visible;
        }
        .chart-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            border: 1px solid var(--main-color);
            padding: 5px 10px;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 100;
            box-shadow: 0 0 10px var(--main-color);
        }
        .pie-slice {
            cursor: crosshair;
            transition: opacity 0.2s;
        }
        .pie-slice:hover { opacity: 0.7; }
        
        .line-path {
            stroke-dasharray: 2000;
            stroke-dashoffset: 2000;
            animation: drawLine 3s ease-out forwards;
        }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }

        /* --- RETURNS TABLE (UPDATED) --- */
        .returns-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.85rem; /* Increased size */
        }
        .returns-table td, .returns-table th {
            border-bottom: 1px solid var(--dim-color);
            padding: 12px; /* More breathing room */
            text-align: left;
        }
        .returns-table th { 
            color: var(--dim-color);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--main-color);
        }
        .returns-table td:last-child, .returns-table th:last-child {
            text-align: right;
        }
        .returns-table tr:last-child td {
            border-bottom: none;
        }

        /* --- TYPING CURSOR --- */
        .cursor::after {
            content: 'â–ˆ';
            animation: blink 1s step-end infinite;
            color: var(--main-color);
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* --- LOGS --- */
        #updatesContainer {
            font-size: 0.85rem;
            line-height: 1.4;
            color: #ccc;
        }
        .update-entry {
            margin-bottom: 6px; 
            border-left: 2px solid var(--dim-color);
            padding-left: 8px;
        }

        /* Images */
        #imageContainer img { max-width: 100% !important; height: auto !important; }

    </style>
</head>
<body>

<div id="tooltip" class="chart-tooltip"></div>

<div class="crt-container">
    <div id="imageContainer" style="overflow: hidden; height: 0; width: 100%; text-align: center; border-bottom: 2px solid var(--main-color); padding-bottom: 30px; box-sizing: content-box;">
      <img id="headerImage" src="https://i.ibb.co/RpYCHF8W/SIT.jpg" alt="Header Image" style="display: block; margin: auto;">
    <BR></div><BR>
    
    <div style="text-align:center; font-size: 0.8rem; letter-spacing: 3px; margin-top: 5px; opacity: 0.7;">
        /// BUY HIGH, SELL LOW ///
    </div><BR>

    <br>

    <div class="header-section">
        <div id="loading-text" class="header-text"></div>
        <div id="unitprice-text" class="header-text highlight"></div>
        <div id="tendies-text" class="header-text"></div>
    </div>
<BR>
    <div class="dashboard-grid" style="margin-bottom: 1.5rem;">
        <div class="hud-panel">
            <div class="hud-title">CURRENT HOLDINGS</div>
            <div id="table-container"></div>
        </div>

        <div class="hud-panel" style="display:flex; align-items:center; justify-content:center; flex-direction: column;">
            <div class="hud-title">ASSET ALLOCATION</div>
            <div id="pie-chart-container" style="width: 80%; max-width: 300px;"></div>
        </div>

    <div class="hud-panel">
        <div class="hud-title">RETURNS AS AT 31 DEC 25</div>
        <div id="returns-table-container"></div>
    </div>

    <div class="hud-panel">
        <div class="hud-title">HISTORICAL PERFORMANCE</div>
        <div id="graph-container" class="graph-container"></div>
    </div>

    <div class="hud-panel">
        <div class="hud-title">SYSTEM LOGS</div>
        <div id="updatesContainer"></div>
    </div>
        
    <div id="poll-container" style="width:100%; max-width:600px; margin:auto;">
        <div style="text-align:center; font-size: 0.8rem; letter-spacing: 3px; opacity: 0.7; border-top: 1px dashed var(--main-color); padding-top: 10px; margin-bottom: 10px;">\\\ IN THE TRUSTEES WE TRUST \\\</div>
        <script>
            (function(i,s,o,g,r,a,m){
                i['QP']=r;
                i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments) },i[r].l=1*new Date();
                a=s.createElement(o),m=s.getElementsByTagName(o)[0];
                a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//scripts.poll-maker.com/3012/pollembed.js','qp');
        </script>
        <a href="#" data-poll="5551770xfDF94E9a-164" style="width:100%; display:block; text-align:center; color:#00FF41; font-family:'Courier New', monospace; text-decoration:none;"></a>
    </div>

</div>

<script>
    // --- DOM ELEMENTS ---
    const loadingTextEl = document.getElementById('loading-text');
    const unitPriceTextEl = document.getElementById('unitprice-text');
    const tendiesTextEl = document.getElementById('tendies-text');
    const tableContainerEl = document.getElementById('table-container');
    const pieChartContainerEl = document.getElementById('pie-chart-container');
    const returnsTableContainerEl = document.getElementById('returns-table-container');
    const graphContainerEl = document.getElementById('graph-container');
    const tooltipEl = document.getElementById('tooltip');

    const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvIkFEd8DqGzQOSMan7QNAuwDI4fXgD1HB8PDbmnnqk5QmA0YNigbxyWuuKhoAys9VRKrbDqym2xDw/pub?output=csv';

    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    // --- UTILITIES ---
    async function typeText(element, text, speed = 30) {
        element.classList.add('cursor');
        element.innerHTML = "";
        let currentText = "";
        for (let i = 0; i < text.length; i++) {
            currentText += text.charAt(i);
            element.innerHTML = currentText;
            await sleep(speed + Math.random() * 20);
        }
        element.classList.remove('cursor');
    }

    async function typeDots(element, count = 3, speed = 300) {
        element.classList.add('cursor');
        for (let i = 0; i < count; i++) {
            element.textContent += '.';
            await sleep(speed);
        }
        element.classList.remove('cursor');
    }

    function parseCSV(str) {
        const arr = [];
        let quote = false; 
        let col, c;
        for (let row = col = c = 0; c < str.length; c++) {
            const cc = str[c], nc = str[c+1];
            arr[row] = arr[row] || [];
            arr[row][col] = arr[row][col] || '';

            if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }
            if (cc == '"') { quote = !quote; continue; }
            if (cc == ',' && !quote) { ++col; continue; }
            if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; continue; }
            if (cc == '\n' && !quote) { ++row; col = 0; continue; }
            if (cc == '\r' && !quote) { ++row; col = 0; continue; }
            
            arr[row][col] += cc;
        }
        return arr;
    }

    async function getSheetData() {
        try {
            const response = await fetch(SPREADSHEET_URL);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvText = await response.text();
            return parseCSV(csvText);
        } catch (e) {
            console.error("Error:", e);
            loadingTextEl.textContent = "FATAL ERROR: DATA LINK SEVERED.";
            return null;
        }
    }

    // --- RENDERERS ---

    function drawTable(data) {
        const holdings = data.slice(2).filter(row => row[0]);
        const fmtUSD0 = (n) => {
            const num = parseFloat(n);
            if (isNaN(num)) return n || '$0';
            return num.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
        };
        const fmtPct = (v) => {
            const raw = (v ?? '').toString().trim();
            if (raw === '') return '0%';
            if (raw.endsWith('%')) return raw;
            const num = parseFloat(raw);
            return isNaN(num) ? raw : `${num}%`;
        };

        let html = '<div class="holdings-grid-container">';
        
        for (let i = 0; i < holdings.length; i += 2) {
            const left = holdings[i];
            const right = holdings[i + 1];

            const createCard = (item) => {
                if(!item) return '';
                const name = item[0] || 'N/A';
                const value = fmtUSD0(item[3]); 
                const profit = fmtPct(item[6]);
                const profitVal = parseFloat(profit);
                const profitColor = profitVal < 0 ? '#ff4444' : '#00FF41';

                return `
                    <div class="holding-card">
                        <span class="holding-name" title="${name}">${name}</span>
                        <div class="holding-row"><span>Val:</span><span>${value}</span></div>
                        <div class="holding-row"><span>P/L:</span><span style="color:${profitColor}">${profit}</span></div>
                    </div>
                `;
            }

            if(left && left[0]) html += createCard(left);
            if(right && right[0]) html += createCard(right);
        }
        html += '</div>';
        tableContainerEl.innerHTML = html;
    }

    function drawPieChart(data) {
        const holdingsData = data.slice(2)
            .filter(row => row[0] && parseFloat(row[3]) > 0)
            .map(row => ({ name: row[0], value: parseFloat(row[3]) }));

        const totalValue = holdingsData.reduce((sum, item) => sum + item.value, 0);
        if (totalValue === 0) {
             pieChartContainerEl.innerHTML = '<div style="text-align:center">NO ASSETS</div>';
             return;
        }

        const radius = 100;
        const cx = radius;
        const cy = radius;
        let startAngle = -90;

        let svgContent = `<svg viewBox="0 0 ${radius * 2} ${radius * 2}" preserveAspectRatio="xMidYMid meet">`;

        holdingsData.forEach((item, index) => {
            const percentage = item.value / totalValue;
            const angle = percentage * 360;
            const endAngle = startAngle + angle;

            const start = polarToCartesian(cx, cy, radius, endAngle);
            const end = polarToCartesian(cx, cy, radius, startAngle);
            const largeArcFlag = angle > 180 ? "1" : "0";

            const d = [
                "M", cx, cy,
                "L", end.x, end.y,
                "A", radius, radius, 0, largeArcFlag, 1, start.x, start.y,
                "Z"
            ].join(" ");

            const lightness = 20 + (index * (60 / holdingsData.length));
            const fill = `hsl(135, 100%, ${lightness}%)`;

            const tooltipText = `${item.name}: ${item.value.toLocaleString('en-US', {style:'currency', currency:'USD', maximumFractionDigits:0})} (${Math.round(percentage*100)}%)`;

            svgContent += `<path d="${d}" fill="${fill}" stroke="#000" stroke-width="1" class="pie-slice" 
                           ontouchstart="showTooltip(event.touches[0], '${tooltipText}')"
                           onmousemove="showTooltip(evt, '${tooltipText}')" 
                           onmouseout="hideTooltip()"></path>`;
            
            startAngle = endAngle;
        });

        svgContent += `</svg>`;
        pieChartContainerEl.innerHTML = svgContent;
    }

    function showTooltip(evt, text) {
        tooltipEl.style.display = "block";
        tooltipEl.textContent = text;
        tooltipEl.style.left = (evt.pageX + 10) + 'px';
        tooltipEl.style.top = (evt.pageY + 10) + 'px';
    }

    function hideTooltip() {
        tooltipEl.style.display = "none";
    }

    function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
        return {
            x: centerX + (radius * Math.cos(angleInRadians)),
            y: centerY + (radius * Math.sin(angleInRadians))
        };
    }

    function drawLineGraph(data) {
        const graphData = data.slice(1)
            .filter(row => row[7] && row[8])
            .map(row => {
                const dateParts = row[7].split('/');
                return {
                    date: new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`),
                    value: parseFloat(row[8])
                };
            })
            .sort((a, b) => a.date - b.date);

        if (graphData.length < 2) return;

        const width = 800;
        const height = 400;
        const padding = 50;

        const maxValue = Math.max(...graphData.map(d => d.value));
        const yMax = Math.ceil(maxValue / 10000) * 10000;
        
        const startDate = new Date('2017-01-01');
        const today = new Date();
        const theEndDate = new Date(today.getFullYear() + 1, 0, 1);

        const xScale = (date) => padding + ((date - startDate) / (theEndDate - startDate)) * (width - padding * 2);
        const yScale = (value) => height - padding - (value / yMax) * (height - padding * 2);

        let svgContent = `<svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">`;

        // Axes and Grids
        svgContent += `<line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="#00FF41" stroke-width="2"></line>`;
        svgContent += `<line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#00FF41" stroke-width="2"></line>`;

        for (let i = 0; i <= yMax; i += 10000) {
            const y = yScale(i);
            svgContent += `<line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="#004400" stroke-width="1" stroke-dasharray="4"></line>`;
            svgContent += `<text x="${padding - 10}" y="${y + 6}" fill="#00FF41" text-anchor="end" font-size="14">$${i / 1000}K</text>`;
        }

        for (let year = 2017; year <= today.getFullYear() + 1; year++) {
            const x = xScale(new Date(`${year}-01-01`));
            svgContent += `<text x="${x}" y="${height - padding + 25}" fill="#00FF41" text-anchor="middle" font-size="14">${year}</text>`;
        }
        
        const points = graphData.map(d => `${xScale(d.date)},${yScale(d.value)}`).join(' ');
        
        svgContent += `<polyline points="${points}" fill="none" stroke="#00FF41" stroke-width="3" class="line-path"></polyline>`;
        
        svgContent += `</svg>`;
        graphContainerEl.innerHTML = svgContent;
    }

    function drawReturnsTable(data) {
        const safeGet = (r, c) => (data[r] && typeof data[r][c] !== 'undefined') ? data[r][c] : '';
        const periods = [
            { label: '1 Month', val: safeGet(1, 11) },
            { label: '3 Month', val: safeGet(2, 11) },
            { label: '6 Month', val: safeGet(3, 11) },
            { label: '1 Year', val: safeGet(4, 11) }
        ];

        let html = '<table class="returns-table">';
        html += '<thead><tr><th>PERIOD</th><th>RETURN</th></tr></thead><tbody>';
        
        periods.forEach(p => {
            let color = '#00FF41';
            let valStr = p.val;
            if(valStr && valStr.includes('-')) color = '#ff4444';
            
            if(!valStr.includes('%') && valStr !== '') {
                const f = parseFloat(valStr);
                if(!isNaN(f)) valStr = f.toFixed(2) + '%';
            }

            html += `<tr><td>${p.label}</td><td style="color:${color}; font-weight:bold;">${valStr}</td></tr>`;
        });
        html += '</tbody></table>';
        returnsTableContainerEl.innerHTML = html;
    }

    function loadPortfolioUpdates(data) {
        const updates = data.slice(1)
            .map(row => row[9])
            .filter(item => item && item.trim() !== '');

        const container = document.getElementById('updatesContainer');
        container.innerHTML = '';

        if (updates.length === 0) {
            container.innerHTML = 'No recent system logs.';
            return;
        }

        updates.forEach((update) => {
            const div = document.createElement('div');
            div.className = 'update-entry';
            div.textContent = `> ${update}`;
            container.appendChild(div);
        });
    }

    // --- MAIN EXECUTION ---
    async function main() {
        await typeText(loadingTextEl, 'FETCHING SQUAD INVEST NUMBERS.', 30);
        await typeDots(loadingTextEl, 5, 100);
        await sleep(300);
        
        const sheetData = await getSheetData();
        
        if (!sheetData) return;

        loadingTextEl.innerHTML = '';
        await typeText(loadingTextEl, 'FOUND 6 and 7, ANALYSING.', 30);
        await typeDots(loadingTextEl, 5, 100);
        await sleep(300);
        loadingTextEl.innerHTML = ''; 

        const jokingValue = parseFloat(sheetData[1][3]).toLocaleString('en-US', { style: 'currency', currency: 'USD' }) || '$0';
        const unitRaw = sheetData[1][4];
        const unitPrice = parseFloat(unitRaw).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        const tendiesValue = parseFloat(sheetData[1][5]).toLocaleString('en-US', { style: 'currency', currency: 'USD' }) || '$0';

        typeText(loadingTextEl, `> TOTAL AUM: ${jokingValue}`);
        setTimeout(() => typeText(unitPriceTextEl, `> UNIT PRICE: ${unitPrice}`), 500);
        setTimeout(() => typeText(tendiesTextEl, `> NET TENDIES: ${tendiesValue}`), 1000);
        
        drawTable(sheetData);
        drawPieChart(sheetData);
        drawReturnsTable(sheetData);
        drawLineGraph(sheetData);
        loadPortfolioUpdates(sheetData);
    }

    window.onload = main;

    window.addEventListener('load', () => {
        const image = document.getElementById('headerImage');
        const container = document.getElementById('imageContainer');
        const step = 5;
        const fps = 60;
        const reveal = () => {
            let height = 0;
            const targetHeight = image.naturalHeight || 400;
            const interval = setInterval(() => {
                height += step;
                container.style.height = height + 'px';
                if (height >= targetHeight) {
                    container.style.height = 'auto';
                    clearInterval(interval);
                }
            }, 1000 / fps);
        };
        if (image.complete) reveal();
        else image.onload = reveal;
    });

</script>
</body>
</html>
