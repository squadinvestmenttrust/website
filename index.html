<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squad Investment Trust</title>
    <style>
        :root {
            --main-color: #00FF41;
            --bg-color: #000000;
            --font-family: 'Courier New', Courier, monospace;
        }
        body {
            background-color: var(--bg-color);
            color: var(--main-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 1rem;
            font-size: 16px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            width: 100%;        /* allow full viewport width */
            margin: auto;
        }
        .header-text {
            min-height: 1.2em;
            font-size: 1.2rem;
            white-space: pre-wrap;
        }
        .content-wrapper {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 2rem;
            align-items: flex-start;
        }
        .table-container {
            flex: 1;
            font-size: 1.1rem;
            white-space: pre;
            overflow-x: visible;  /* let the table fill the width */
        }
        .chart-container {
            flex: 1;
            min-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .graph-container {
            width: 100%;
        }
        svg {
            width: 100%;
            height: auto;
            stroke: var(--main-color);
            fill: var(--main-color);
            stroke-width: 2;
            font-family: var(--font-family);
        }
        .pie-chart-label,
        .graph-label {
            font-size: 12px;
            fill: var(--main-color);
            stroke: none;
            text-anchor: middle;
        }
        .graph-axis-label-y {
            text-anchor: end;
        }
        .cursor::after {
            content: '█';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { opacity: 1; }
            50%     { opacity: 0; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="loading-text" class="header-text"></div>
        <div id="tendies-text" class="header-text"></div>

        <div class="content-wrapper">
            <div id="table-container" class="table-container"></div>
            <div id="pie-chart-container" class="chart-container"></div>
        </div>

        <div id="graph-container" class="graph-container"></div>
    </div>

    <script>
        const loadingTextEl     = document.getElementById('loading-text');
        const tendiesTextEl     = document.getElementById('tendies-text');
        const tableContainerEl  = document.getElementById('table-container');
        const pieChartContainerEl = document.getElementById('pie-chart-container');
        const graphContainerEl  = document.getElementById('graph-container');

        const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvIkFEd8DqGzQOSMan7QNAuwDI4fXgD1HB8PDbmnnqk5QmA0YNigbxyWuuKhoAys9VRKrbDqym2xDw/pub?output=csv';

        const sleep = ms => new Promise(res => setTimeout(res, ms));

        async function typeText(el, txt, speed=50) {
            el.classList.add('cursor');
            for (let i=0; i<txt.length; i++) {
                el.textContent = txt.substring(0, i+1);
                await sleep(speed);
            }
            el.classList.remove('cursor');
        }
        async function typeDots(el, count=5, speed=200) {
            el.classList.add('cursor');
            for (let i=0; i<count; i++) {
                el.textContent += '.';
                await sleep(speed);
            }
            el.classList.remove('cursor');
        }

        async function getSheetData() {
            try {
                const res = await fetch(SPREADSHEET_URL);
                if (!res.ok) throw new Error(`Status ${res.status}`);
                const text = await res.text();
                return text.split('\n').map(r => r.trim().split(','));
            } catch (e) {
                console.error(e);
                loadingTextEl.textContent = "Error: Could not load spreadsheet data.";
                return null;
            }
        }

        function drawTable(data) {
            const rows = data.slice(2).filter(r => r[0]);
            const headers = ['Holding','Value','Profit $','Profit %'];
            // determine widths
            const colW = headers.map(h => h.length);
            const formatted = rows.map(r => {
                const h = r[0] || '';
                const v = '$' + (r[3] || '0');
                const p$ = '$' + (r[5] || '0');
                const p% = (r[6] || '0') + '%';
                colW[0] = Math.max(colW[0], h.length);
                colW[1] = Math.max(colW[1], v.length);
                colW[2] = Math.max(colW[2], p$.length);
                colW[3] = Math.max(colW[3], p%.length);
                return [h, v, p$, p%];
            });
            // build border
            let border = '+';
            colW.forEach(w => border += '-'.repeat(w+2) + '+');
            // header row
            let hdr = '|';
            headers.forEach((h,i) => hdr += ' ' + h.padEnd(colW[i]) + ' |');
            // body
            const body = formatted.map(cols => {
                let line = '|';
                cols.forEach((c,i) => line += ' ' + c.padEnd(colW[i]) + ' |');
                return line;
            });
            const tableStr = [border, hdr, border, ...body, border].join('\n');
            typeText(tableContainerEl, tableStr, 5);
        }

        function polarToCartesian(cx,cy,r,deg){
            const rad = (deg-90)*Math.PI/180;
            return { x: cx + r*Math.cos(rad), y: cy + r*Math.sin(rad) };
        }

        function drawPieChart(data) {
            const items = data.slice(2)
                .filter(r=>r[0]&&parseFloat(r[3])>0)
                .map(r=>({name:r[0], value:parseFloat(r[3])}));
            const total = items.reduce((s,i)=>s+i.value,0);
            if (total===0) return;
            const r = 100, cx=r, cy=r;
            let angle= -90, svg = `<svg viewBox="0 0 ${2*r} ${2*r}">`;
            items.forEach(it=>{
                const pct = it.value/total, Δ = pct*360, end=angle+Δ;
                const startP = polarToCartesian(cx,cy,r,end);
                const endP   = polarToCartesian(cx,cy,r,angle);
                const laf = Δ>180?1:0;
                svg += `<path d="M ${cx} ${cy} L ${endP.x} ${endP.y} A ${r} ${r} 0 ${laf} 1 ${startP.x} ${startP.y} Z" fill="none" stroke-width="2"/>`;
                const mid = angle + Δ/2;
                const lp = polarToCartesian(cx,cy,r*0.7,mid);
                svg += `<text x="${lp.x}" y="${lp.y}" class="pie-chart-label">${it.name} ${Math.round(pct*100)}%</text>`;
                angle = end;
            });
            svg += `</svg>`;
            pieChartContainerEl.innerHTML = svg;
        }

        function drawLineGraph(data) {
            const pts = data.slice(1)
                .filter(r=>r[7]&&r[8])
                .map(r=>{
                    const [d,m,y] = r[7].split('/');
                    return {d: new Date(`${y}-${m}-${d}`), v: parseFloat(r[8])};
                })
                .sort((a,b)=>a.d-b.d);
            if (pts.length<2) return;
            const W=800,H=400,P=60;
            const maxV = Math.ceil(Math.max(...pts.map(p=>p.v))/10000)*10000;
            const startD = new Date('2017-01-01'), endD = new Date('2025-12-31');
            const xS = d => P + ((d - startD)/(endD - startD))*(W-2*P);
            const yS = v => H - P - (v/maxV)*(H-2*P);
            let svg = `<svg viewBox="0 0 ${W} ${H}">`;
            // grid & axes
            svg += `<line x1="${P}" y1="${P}" x2="${P}" y2="${H-P}" stroke-width="1"/>`;
            for(let v=0; v<=maxV; v+=10000){
                const y = yS(v);
                svg += `<line x1="${P-5}" y1="${y}" x2="${W-P}" y2="${y}" stroke-width="0.5" stroke-dasharray="4"/>`;
                svg += `<text x="${P-10}" y="${y+4}" class="graph-label graph-axis-label-y">$${v/1000}K</text>`;
            }
            svg += `<line x1="${P}" y1="${H-P}" x2="${W-P}" y2="${H-P}" stroke-width="1"/>`;
            for(let yr=2017; yr<=2025; yr++){
                const x = xS(new Date(`${yr}-01-01`));
                svg += `<text x="${x}" y="${H-P+20}" class="graph-label">${yr}</text>`;
            }
            // line
            const ptsStr = pts.map(p=>`${xS(p.d)},${yS(p.v)}`).join(' ');
            svg += `<polyline points="${ptsStr}" fill="none" stroke-width="3"/>`;
            svg += `</svg>`;
            graphContainerEl.innerHTML = svg;
        }

        async function main() {
            await typeText(loadingTextEl, 'Loading', 80);
            await typeDots(loadingTextEl, 5, 250);
            await sleep(500);
            await typeText(loadingTextEl, '.....and it\'s gone', 80);
            await sleep(1000);

            const data = await getSheetData();
            if (!data) return;

            await typeText(loadingTextEl, `joking, you have $${data[1][3]||'0'}`);
            await typeText(tendiesTextEl, `Total tendies to date $${data[1][5]||'0'}`);

            drawTable(data);
            drawPieChart(data);
            drawLineGraph(data);
        }

        window.onload = main;
    </script>
</body>
</html>
