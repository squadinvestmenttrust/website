<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Squad Investment Trust</title>
  <style>
    body {
      background-color: black;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      padding: 20px;
    }
    .line {
      white-space: pre;
    }
    table {
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px dashed #00ff00;
      padding: 5px 10px;
    }
    #tableContainer, #pieContainer, #chartContainer {
      margin-top: 20px;
    }
    #row {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
      align-items: start;
    }
    canvas {
      background-color: black;
    }
    @media (max-width: 768px) {
      #row {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="line" id="message"></div>
  <div class="line" id="tendies"></div>
  <div id="row">
    <div id="tableContainer"></div>
    <div>
      <canvas id="pieChart" width="300" height="300"></canvas>
    </div>
  </div>
  <div id="chartContainer">
    <canvas id="lineChart" width="800" height="400"></canvas>
  </div>

  <script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvIkFEd8DqGzQOSMan7QNAuwDI4fXgD1HB8PDbmnnqk5QmA0YNigbxyWuuKhoAys9VRKrbDqym2xDw/pub?output=csv';

    async function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function startLoading() {
      const msgEl = document.getElementById('message');
      msgEl.textContent = 'Loading';
      for (let i = 0; i < 5; i++) {
        msgEl.textContent += '.';
        await delay(400);
      }
      await delay(500);
      msgEl.textContent = '.....and it\'s gone';
      await delay(700);
    }

    async function fetchCSV() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const rows = text.split('\n').map(row => row.split(','));
      return rows;
    }

    function formatMoney(value) {
      return '$' + Number(value).toLocaleString();
    }

    async function renderData() {
      const data = await fetchCSV();
      const message = document.getElementById('message');
      const tendies = document.getElementById('tendies');
      const tableContainer = document.getElementById('tableContainer');

      const totalVal = data[1][3];
      const tendiesVal = data[1][5];

      message.textContent = `just joking, you have ${formatMoney(totalVal)}`;
      tendies.textContent = `Total tendies to date ${formatMoney(tendiesVal)}`;

      let tableHTML = '<table><tr><th>Holding</th><th>Value</th><th>Profit $</th><th>Profit %</th></tr>';
      const holdings = [];
      const values = [];
      for (let i = 2; i < data.length; i++) {
        if (!data[i][0]) continue;
        tableHTML += `<tr><td>${data[i][0]}</td><td>${formatMoney(data[i][3])}</td><td>${formatMoney(data[i][5])}</td><td>${data[i][6]}%</td></tr>`;
        holdings.push(data[i][0]);
        values.push(parseFloat(data[i][3]));
      }
      tableHTML += '</table>';
      tableContainer.innerHTML = tableHTML;

      const pieCtx = document.getElementById('pieChart').getContext('2d');
      new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: holdings,
          datasets: [{
            data: values,
            backgroundColor: values.map(() => 'rgba(0,0,0,0)'),
            borderColor: '#00ff00',
            borderWidth: 1
          }]
        },
        options: {
          plugins: {
            legend: {
              labels: { color: '#00ff00' }
            },
            tooltip: { enabled: false }
          }
        }
      });

      const dateRow = data[0];
      const valueRow = data[1];
      const dates = dateRow.slice(7).map(d => {
        const [day, month, year] = d.split('/');
        return `${year}`;
      });
      const valuesLine = valueRow.slice(7).map(v => parseFloat(v));

      const lineCtx = document.getElementById('lineChart').getContext('2d');
      new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Portfolio Value',
            data: valuesLine,
            borderColor: '#00ff00',
            borderWidth: 2,
            pointRadius: 0
          }]
        },
        options: {
          scales: {
            y: {
              ticks: {
                color: '#00ff00',
                callback: val => `$${val / 1000}K`
              },
              grid: { color: '#004400' }
            },
            x: {
              ticks: { color: '#00ff00' },
              grid: { color: '#004400' }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          }
        }
      });
    }

    (async function init() {
      await startLoading();
      await renderData();
    })();
  </script>
</body>
</html>
