<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Squad Investment Trust</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --green:#00ff00; }
    body{
      background:black;
      color:var(--green);
      font-family:'Courier New',monospace;
      font-size:18px;
      margin:0;
      padding:20px;
    }
    #loading,#tendies,#table{white-space:pre;margin-bottom:20px;}
    .row{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;}
    #table{flex:1 1 320px;}
    #pieWrapper{flex:1 1 320px;}
    canvas{background:black;width:100%;height:auto;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
  <div id="loading"></div>
  <div id="tendies"></div>

  <div class="row">
    <pre id="table"></pre>
    <div id="pieWrapper"><canvas id="pieChart"></canvas></div>
  </div>

  <canvas id="lineChart"></canvas>

  <script>
    const SHEET_CSV='https://docs.google.com/spreadsheets/d/e/2PACX-1vQvIkFEd8DqGzQOSMan7QNAuwDI4fXgD1HB8PDbmnnqk5QmA0YNigbxyWuuKhoAys9VRKrbDqym2xDw/pub?output=csv';
    const delay=ms=>new Promise(r=>setTimeout(r,ms));

    async function type(el,text,speed=20){
      for(const ch of text){el.textContent+=ch;await delay(speed);}
    }

    async function showLoader(){
      const el=document.getElementById('loading');
      await type(el,'Loading',70);
      for(let i=0;i<5;i++){await delay(500);el.textContent+='.';}
      await delay(500);
      el.textContent+='\n';
      await type(el,".....and it's gone",60);
      await delay(800);
    }

    function parseCSV(t){
      return t.trim().split(/\r?\n/).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c=>c.replace(/^"|"$/g,'')));
    }
    const num=s=>parseFloat(s.replace(/[$,%]/g,'').replace(/,/g,''));

    function holdingsData(rows){
      const arr=[];
      for(let i=2;i<rows.length;i++){
        const [name,, ,val,,profit,pct]=rows[i];
        if(name)arr.push({name,value:num(val),profit:num(profit),pct:pct.trim()});
      }
      return arr;
    }
    function historyData(rows){
      const hist=[];
      for(let i=1;i<rows.length;i++){
        const d=rows[i][7],v=rows[i][8];
        if(d&&v){
          hist.push({year:d.split('/')[2],value:num(v)});
        }
      }
      return hist;
    }
    function asciiTable(data){
      const heads=['Holding','Value','Profit $','Profit %'];
      const w=[
        Math.max(...data.map(x=>x.name.length),heads[0].length),
        Math.max(...data.map(x=>x.value.toLocaleString().length),heads[1].length),
        Math.max(...data.map(x=>x.profit.toLocaleString().length),heads[2].length),
        Math.max(...data.map(x=>x.pct.length),heads[3].length)
      ];
      const line=ch=>'+'+w.map(x=>ch.repeat(x+2)).join('+')+'+\n';
      let out=line('-');
      out+='|'+heads.map((h,i)=>' '+h.padEnd(w[i])+' ').join('|')+'|\n';
      out+=line('-');
      data.forEach(r=>{
        out+='|'+' '+r.name.padEnd(w[0])+'|'
              +' '+r.value.toLocaleString().padStart(w[1])+'|'
              +' '+r.profit.toLocaleString().padStart(w[2])+'|'
              +' '+r.pct.padStart(w[3])+'|\n';
      });
      out+=line('-');
      return out;
    }

    function pieChart(holdings){
      new Chart(document.getElementById('pieChart'),{
        type:'pie',
        data:{
          labels:holdings.map(h=>h.name),
          datasets:[{
            data:holdings.map(h=>h.value),
            backgroundColor:holdings.map(()=> 'rgba(0,0,0,0)'),
            borderColor:holdings.map(()=> '#00ff00'),
            borderWidth:2
          }]
        },
        options:{
          plugins:{
            legend:{display:false},
            tooltip:{enabled:false},
            datalabels:{
              color:'#00ff00',
              formatter:(v,ctx)=>{
                const sum=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                return ctx.chart.data.labels[ctx.dataIndex]+' '+Math.round(v/sum*100)+'%';
              }
            }
          }
        },
        plugins:[ChartDataLabels]
      });
    }

    function lineChart(hist){
      const labels=hist.map(h=>h.year),vals=hist.map(h=>h.value);
      const mx=Math.max(...vals),step=10000,top=Math.ceil(mx/step)*step;
      new Chart(document.getElementById('lineChart'),{
        type:'line',
        data:{labels,datasets:[{data:vals,borderColor:'#00ff00',borderWidth:2,pointRadius:0,fill:false,tension:0}]},
        options:{
          plugins:{legend:{display:false},tooltip:{enabled:false}},
          scales:{
            x:{grid:{color:'#003300',lineWidth:0.2},
               ticks:{color:'#00ff00',callback:(v,i)=>i===0||labels[i]!==labels[i-1]?labels[i]:''}},
            y:{beginAtZero:true,max:top,ticks:{stepSize:step,color:'#00ff00',callback:v=>'$'+v/1000+'K'},
               grid:{color:'#003300',lineWidth:0.2}}
          }
        }
      });
    }

    (async()=>{
      const csvP=fetch(SHEET_CSV).then(r=>r.text()).then(parseCSV);
      await showLoader();
      const rows=await csvP;
      const cash=num(rows[1][3]).toLocaleString();
      const tend=num(rows[1][5]).toLocaleString();

      const load=document.getElementById('loading');
      load.textContent='';
      await type(load,'just joking, you have $'+cash,20);

      await type(document.getElementById('tendies'),'Total tendies to date $'+tend,20);

      const holds=holdingsData(rows);
      await type(document.getElementById('table'),asciiTable(holds),1);

      pieChart(holds);
      lineChart(historyData(rows));
    })();
  </script>
</body>
</html>
